<html>
	<head>
		<script src="nui://game/ui/jquery.js" type="text/javascript"></script>
		<script src="js/http.js" type="text/javascript"></script>
		<style>
			html,
			body {
				margin: 0;
				padding: 0;
				background: transparent;
				overflow: hidden;
			}

			#recordPrinterContainer {
				position: absolute;
				inset: 0;
				z-index: 10;
			}

			#bodycamOverlayContainer {
				position: absolute;
				inset: 0;
				display: none;
				pointer-events: none;
				z-index: 999;
			}

			#bodycamOverlayImage {
				position: absolute;
				display: none;
				height: 6vh;
			}
		</style>
	</head>
	<body>
		<div id="recordPrinterContainer"></div>
		<div id="bodycamOverlayContainer">
			<img src="./img/logo.gif" alt="header" id="bodycamOverlayImage" />
		</div>
		<script>
			// CRED: https://stackoverflow.com/questions/6150289/how-can-i-convert-an-image-into-base64-string-using-javascript/20285053#20285053
			function toDataUrl(url, callback) {
				var xhr = new XMLHttpRequest();
				xhr.onload = function () {
					var reader = new FileReader();
					reader.onloadend = function () {
						callback(reader.result);
					};
					reader.readAsDataURL(xhr.response);
				};
				xhr.open("GET", url);
				xhr.responseType = "blob";
				xhr.send();
			}
			var audioPlayer = null;
			window.addEventListener("message", function (event) {
				if (event.data.type === "convert_base64") {
					toDataUrl(event.data.img, function (base64) {
						fetch(`https://${GetParentResourceName()}/base64`, {
							method: "POST",
							headers: { "Content-Type": "application/json; charset=UTF-8" },
							body: JSON.stringify({
								base64: base64,
								handle: event.data.handle,
								id: event.data.id,
							}),
						});
					});
				}
			});
		</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.1.1/howler.min.js" type="text/javascript"></script>
		<script>
			var audioPlayer = null;
			var bodycamOverlayVisible = false;
			const recordPrinterContainer = document.getElementById("recordPrinterContainer");
			const overlayContainer = document.getElementById("bodycamOverlayContainer");
			const overlayImage = document.getElementById("bodycamOverlayImage");
			const recordPrinterFrame = document.createElement("iframe");
			recordPrinterFrame.src = `https://cfx-nui-${GetParentResourceName()}/submodules/recordPrinter/html/ui.html`;
			recordPrinterFrame.style.position = "absolute";
			recordPrinterFrame.style.top = "0px";
			recordPrinterFrame.style.left = "0px";
			recordPrinterFrame.style.right = "0px";
			recordPrinterFrame.style.bottom = "0px";
			recordPrinterFrame.style.width = "100%";
			recordPrinterFrame.style.height = "100%";
			recordPrinterFrame.style.border = "0px";
			recordPrinterFrame.style.zIndex = "10";
			recordPrinterContainer.appendChild(recordPrinterFrame);
			function positionOverlay(location) {
				overlayImage.style.top = "";
				overlayImage.style.right = "";
				overlayImage.style.bottom = "";
				overlayImage.style.left = "";

				switch (location) {
					case "top-left":
						overlayImage.style.top = "0";
						overlayImage.style.left = "0";
						break;
					case "top-right":
						overlayImage.style.top = "0";
						overlayImage.style.right = "0";
						break;
					case "bottom-left":
						overlayImage.style.bottom = "0";
						overlayImage.style.left = "0";
						break;
					case "bottom-right":
						overlayImage.style.bottom = "0";
						overlayImage.style.right = "0";
						break;
				}
			}

			function setOverlayVisibility(visible, location) {
				bodycamOverlayVisible = !!visible;
				if (bodycamOverlayVisible) {
					overlayContainer.style.display = "block";
					overlayImage.style.display = "block";
					positionOverlay(location || "top-left");
				} else {
					overlayImage.style.display = "none";
					overlayContainer.style.display = "none";
				}
			}

			window.addEventListener("message", function (event) {
				if (event.data.recordPrinter) {
					console.log("Forwarding message to recordPrinterFrame:", event.data);
					recordPrinterFrame.contentWindow.postMessage(event.data, "*");
				}
				if (event.data.type == "playSound") {
					if (audioPlayer != null) {
						audioPlayer.pause();
					}
					audioPlayer = new Howl({
						src: [event.data.transactionFile],
					});
					audioPlayer.volume(event.data.transactionVolume);
					audioPlayer.play();
				}
				if (event.data.type === "bodycamOverlay") {
					setOverlayVisibility(event.data.visible, event.data.location);
				} else if (event.data.type === "toggleGif") {
					// Backwards compatibility: flip current visibility
					const nextVisibility = !bodycamOverlayVisible;
					const location = nextVisibility ? event.data.location : null;
					setOverlayVisibility(nextVisibility, location);
				}
			});
		</script>
	</body>
</html>
